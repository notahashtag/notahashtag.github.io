@page "/random-selection"

<h1 class='mb-4'>Random Selection</h1>

<div class='container'>
    <div class='row'>
        <div class='col-md-6 mb-4'>
            <label for='input' class='form-label'>List Input <i>(1 per line)</i></label>
            <textarea id='input' class='form-control' rows='8'
                @bind='InputText' @bind:event="oninput"></textarea>
        </div>
        <div class='col-md-6 mb-4'>
            <label for='results' class='form-label'>Results</label>
            <textarea id='results' class='form-control' rows='8' readonly
                >@ResultsList</textarea>
        </div>
    </div>
    <div class='row'>
        <div class='col-md-6 mb-4'>
            <label for='rolls' class='form-label'>Number of Rolls: @Rolls</label>
            <input id='rolls' type='range' min='1' max='50' class='form-range' @bind-value="Rolls" @bind-value:event="oninput" />
        </div>
        <div class='col-md-6 mb-4 text-center'>
            @if (Winner is not null)
            {
                <h4>
                    <span class='badge text-bg-info text-wrap'>
                        <span class='badge text-bg-secondary'>@Winner.Split(". ").First()</span>
                        @Winner.Split(". ").Last()
                    </span>
                </h4>
            }
        </div>
    </div>
    <div class='row \'>
        <div class='col-md-6 mb-4'>
            <button class='btn btn-primary' @onclick='CleanAndRandomize'
                disabled='@string.IsNullOrWhiteSpace(InputText)'>Randomized Selection</button>
            <button class='btn btn-secondary float-end' @onclick="Reset">Reset</button>
        </div>
        <div class='col-md-6 mb-4'>
            <span></span>
        </div>
    </div>
</div>

<script>
    window.scrollToEnd = (elementId) => {
        const el = document.getElementById(elementId);
        if (el) {
            el.scrollTop = el.scrollHeight;
        }
    };
</script>

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;
    private int Rolls = 25;
    private string InputText = string.Empty;
    private List<string> Lines = new();
    private List<string> Results = new();
    private string ResultsList = string.Empty;
    private string? Winner = null;

    private async Task CleanAndRandomize()
    {
        Results.Clear();
        ResultsList = string.Empty;
        Winner = null;

        InputText = string.Join
            (
                Environment.NewLine,
                InputText
                    .Split(new[] { "\r\n", "\n", "\r" },StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                );

        Lines = InputText
            .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
            .ToList();
        
        if (Lines.Any())
        {
            for (int i = 1; i <= Rolls; i++)
            {
                Results.Add(
                    $"{i}. {Lines[Random.Shared.Next(0,Lines.Count)]}"
                );
            }
            ResultsList = string.Join(Environment.NewLine,Results);
            
            // Wait for Blazor to render the updated textarea
            await InvokeAsync(StateHasChanged);
            await Task.Delay(1); // ensures browser DOM updates

            await JS.InvokeVoidAsync("scrollToEnd", "results");

            Winner = Results.Last();
        }
    }

    private void Reset()
    {
        InputText = string.Empty;
        Lines.Clear();
        Results.Clear();
        ResultsList = string.Empty;
        Rolls = 25;
        Winner = null;
    }
}
